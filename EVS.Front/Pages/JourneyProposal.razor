@page "/journeyproposal"
@using EVS.Core.Models
@using EVS.Front.Services
@using MudBlazor
@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using FluentValidation
@using Severity = MudBlazor.Severity
@inject ISnackbar Snackbar
@inject IRideService rideService;
@inject NavigationManager NavigationManager



<MudGrid Spacing="0">
	<MudItem xs="5">
		<MudText Typo="Typo.h2" Color="Color.Primary" Style="margin:2em 0 0 3em;">Proposez votre Trajet</MudText>

	</MudItem>

		<MudItem xs="7" Style="max-width:100%">
		<MudPaper Style="padding: 1em; margin-top:3em">

			<MudForm @ref="form" @bind-IsValid="@success" Model="ride" @bind-Errors="@errors">

				<MudText Style=" margin:2em 0 1em 0;" Typo="Typo.h5" class="form-label" Color="Color.Primary">D'où partez vous?</MudText>

@* 				<MudTextField @bind-Value="ride.StartCity" T="string" data-google-autocomplete="true" data-value-field="city_from_selectedValue" Placeholder="Ville de départ" Adornment="Adornment.Start" AdornmentColor="Color.Primary" AdornmentIcon="@Icons.Material.Filled.Start" />
				<input type="hidden" name="city_from_selectedValue" value="" /> *@

				<MudGooglePlacesAutocomplete T="string"
											 Placeholder="Ville de départ"
											 OnPlaceChanged="StartChanged"
											 Adornment="Adornment.Start"
											 AdornmentIcon="@Icons.Material.Filled.Start"
											 ApiKey="AIzaSyDfY1D6Gea4uKJ51ppPxwQsyxcjj3An98E" 
											 @bind-Value="ride.StartCity" />


				<MudText Style=" margin:2em 0 1em 0;" Typo="Typo.h5" class="form-label" Color="Color.Primary">Où allez vous?</MudText>

				<MudGooglePlacesAutocomplete T="string"
											 Placeholder="Ville d'arrivée"
											 OnPlaceChanged="EndChanged"
											 Adornment="Adornment.Start"
											 AdornmentIcon="@Icons.Material.Filled.KeyboardTab"
											 ApiKey="AIzaSyDfY1D6Gea4uKJ51ppPxwQsyxcjj3An98E"
											 @bind-Value="ride.EndCity" />




			@* 	<MudTextField @bind-Value="ride.EndCity" T="string" data-google-autocomplete="true" data-value-field="city_to_selectedValue" Placeholder="Ville d'arrivée" Adornment="Adornment.Start" AdornmentColor="Color.Primary" AdornmentIcon="@Icons.Material.Filled.KeyboardTab" />
				<input type="hidden" name="city_to_selectedValue" value="" /> *@

				<MudText Style=" margin:2em 0 1em 0;" Typo="Typo.h5" class="form-label" Color="Color.Primary">Quand souhaitez vous prendre la route?</MudText>
				<MudDatePicker  MinDate="DateTime.Today" Adornment="Adornment.Start" AdornmentColor="Color.Primary" />
				<MudText Style="margin:2em 0 1em 0;" Typo="Typo.h5" class="form-label" Color="Color.Primary">Combien de passagers souaitez-vous emmener ?</MudText>
				<MudGrid Spacing="0" class="counter">

					<MudItem xs="9">

						<MudSlider TickMarks="true" Color="Color.Secondary" @bind-Value="@ride.Seats" TickMarkLabels="@labels" Step="1" Max="5" Min="1" />
					</MudItem>
					<MudItem xs="3">
						<MudText Typo="Typo.h4" Color="Color.Secondary" Style="margin-left:1em">@ride.Seats</MudText>
					</MudItem>
				</MudGrid>

				<MudText Style=" margin:2em 0 1em 0;" Typo="Typo.h5" class="form-label" Color="Color.Primary">Quel est le prix de chaque place ?</MudText>

				<MudGrid Spacing="0" class="counter">

					<MudItem xs="9">
						<MudSlider TickMarks="true" Color="Color.Secondary" @bind-Value="@ride.Price" Step="1" Max="99" Min="1" />
					</MudItem>
					<MudItem xs="3">
						<MudText Typo="Typo.h4" Color="Color.Secondary" Style="margin-left:1em">@ride.Price €</MudText>
					</MudItem>

				</MudGrid>

				<MudCardActions>
					<MudButton Variant="Variant.Filled" Style="margin:2em 0;" Color="Color.Primary" Class="ml-auto" OnClick="Confirm">Creer votre trajet</MudButton>
				</MudCardActions>


			</MudForm>
		</MudPaper>
	</MudItem>

</MudGrid>





@code {

	private DateTime? criteriaDeparture = DateTime.Today.AddDays(1);

	

	[Parameter]
	public Ride ride { get; set; } = new()
	{
			UserId = Guid.Parse("c9469a26-87f5-4019-9d8f-9fa7de4e8050"),
		 StartCity = "Monsby-Sur-Saone",
		EndCity = "Gennelon-Surlapatate",
			Departure = DateTime.Today.AddDays(1),
			Seats = 2,
			Price = 50
	};

	private GooglePlace criteraStart = null;
	private GooglePlace criteraEnd = null;
	

	private void StartChanged(GooglePlace place)
	{
		criteraStart = place;
	}

	private void EndChanged(GooglePlace place)
	{
		criteraEnd = place;
	}

	bool success;
	string[] errors = { };


	private async void Confirm()
	{
		form.Validate();
		if (success)
		{
			Ride? createdRide = await rideService.Create(ride);
			Guid newId = createdRide.Id;
			NavigationManager.NavigateTo("/JourneyLists/" + newId);
		}
	}



	int NumberPrice = 15;
	int NumberPassager;
	string[] labels = new string[] { "1", "2", "3", "4", "5" };

	MudTextField<string> pwField1;
	MudForm form;
	DateTime? date = DateTime.Today;

	private async Task Submit()
	{
		await form.Validate();

		if (form.IsValid)
		{
			Snackbar.Add("Submited!");
		}
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			await JSRuntime.InvokeVoidAsync("initAutocomplete");
		}
	}

	private int counterValueVoyager = 0;
	private int counterValueEuro = 0;

	private void DecrementCounterVoyager()
	{
		if (counterValueVoyager > 0)
		{
			counterValueVoyager--;
		}
	}

	private void IncrementCounterVoyager()
	{
		counterValueVoyager++;
	}

	private void DecrementCounterEuro()
	{
		if (counterValueEuro > 0)
		{
			counterValueEuro--;
		}
	}

	private void IncrementCounterEuro()
	{
		counterValueEuro++;
	}
}
